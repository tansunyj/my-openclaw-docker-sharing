version: '3.8'

services:
  openclaw-gateway:
    # 你的镜像构建命令
    build: .
    image: 591124281yj228/openclaw_ready:latest
    container_name: openclaw-gateway
    restart: unless-stopped
    
    # ❌ 这一行一定要删掉！默认让它用 Root 启动，脚本会自动降级
    # user: "1000:1000"

    working_dir: /app

    environment:
      # 必须指向 /home/node，因为最终我们会切换成 node 用户
      - HOME=/home/node
      - NODE_ENV=production
      - OPENCLAW_GATEWAY_TOKEN=admin123456
      - CLAWDBOT_CONFIG_PATH=/home/node/.openclaw/config.json
      - OPENCLAW_PREFER_PNPM=1

    volumes:
      # ⬇️ 【关键修复】把这里全部改回 /home/node
      # 这样脚本在 /home/node 目录下才能找到这些文件并修复权限
      
      # 1. 核心数据
      - ./data:/home/node/.openclaw
      
      # 2. Agent 工作区
      - ./workspace:/home/node/clawd
      
      # 3. 浏览器缓存
      - ./chrome-data:/home/node/.config/chromium
      
      # 4. 挂载扩展脚本
      - ./install_all.sh:/app/install_all.sh

    ports:
      - "18789:18789"

    deploy:
      resources:
        limits:
          memory: 4G